<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Estado del Sistema - Gestor Financiero</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 2rem;
            background: #f8fafc;
            color: #1e293b;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-ok { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-error { color: #ef4444; }
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem;
        }
        .btn:hover {
            background: #1d4ed8;
        }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Estado del Sistema - Gestor Financiero</h1>
        
        <div class="status-card">
            <h2>üîß Estado de Componentes</h2>
            <div id="component-status">
                <div class="status-item">
                    <span>Cargando...</span>
                    <span>‚è≥</span>
                </div>
            </div>
        </div>
        
        <div class="status-card">
            <h2>üíæ Almacenamiento</h2>
            <div id="storage-status">
                <div class="status-item">
                    <span>Verificando...</span>
                    <span>‚è≥</span>
                </div>
            </div>
        </div>
        
        <div class="status-card">
            <h2>üåê PWA y Service Worker</h2>
            <div id="pwa-status">
                <div class="status-item">
                    <span>Verificando...</span>
                    <span>‚è≥</span>
                </div>
            </div>
        </div>
        
        <div class="status-card">
            <h2>üß™ Pruebas R√°pidas</h2>
            <button class="btn" onclick="runAllTests()" style="background: #059669; margin-right: 1rem;">üöÄ Ejecutar Todas las Pruebas</button>
            <br><br>
            <button class="btn" onclick="testLocalStorage()">Probar localStorage</button>
            <button class="btn" onclick="testSupabase()">Probar Supabase</button>
            <button class="btn" onclick="testPWA()">Probar PWA</button>
            <button class="btn" onclick="clearAllData()">üóëÔ∏è Limpiar Datos</button>
        </div>
        
        <div class="status-card">
            <h2>üìù Log del Sistema</h2>
            <div id="system-log" class="log">Iniciando verificaciones...\n</div>
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
            <a href="index-new.html" class="btn">üè† Volver a la Aplicaci√≥n</a>
        </div>
    </div>

    <script>
        let log = '';
        
        function addLog(message) {
            log += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            document.getElementById('system-log').textContent = log;
            console.log(message);
        }
        
        function updateStatus(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => 
                `<div class="status-item">
                    <span>${item.label}</span>
                    <span class="status-${item.status}">${item.value}</span>
                </div>`
            ).join('');
        }
        
        async function checkComponents() {
            addLog('üîß Verificando componentes...');
            
            const components = [
                {
                    label: 'FullCalendar',
                    status: typeof FullCalendar !== 'undefined' ? 'ok' : 'error',
                    value: typeof FullCalendar !== 'undefined' ? '‚úÖ Cargado' : '‚ùå No encontrado'
                },
                {
                    label: 'Chart.js',
                    status: typeof Chart !== 'undefined' ? 'ok' : 'error',
                    value: typeof Chart !== 'undefined' ? '‚úÖ Cargado' : '‚ùå No encontrado'
                },
                {
                    label: 'Supabase',
                    status: typeof window.supabase !== 'undefined' ? 'ok' : 'error',
                    value: typeof window.supabase !== 'undefined' ? '‚úÖ Cargado' : '‚ùå No encontrado'
                }
            ];
            
            updateStatus('component-status', components);
            addLog('‚úÖ Verificaci√≥n de componentes completada');
        }
        
        async function checkStorage() {
            addLog('üíæ Verificando almacenamiento...');
            
            const storage = [
                {
                    label: 'localStorage',
                    status: typeof Storage !== 'undefined' ? 'ok' : 'error',
                    value: typeof Storage !== 'undefined' ? '‚úÖ Disponible' : '‚ùå No disponible'
                },
                {
                    label: 'Datos guardados',
                    status: localStorage.getItem('gestor_ingresos') ? 'ok' : 'warning',
                    value: localStorage.getItem('gestor_ingresos') ? '‚úÖ Encontrados' : '‚ö†Ô∏è Sin datos'
                }
            ];
            
            updateStatus('storage-status', storage);
            addLog('‚úÖ Verificaci√≥n de almacenamiento completada');
        }
        
        async function checkPWA() {
            addLog('üåê Verificando PWA...');
            
            const pwa = [
                {
                    label: 'Service Worker',
                    status: 'serviceWorker' in navigator ? 'ok' : 'error',
                    value: 'serviceWorker' in navigator ? '‚úÖ Soportado' : '‚ùå No soportado'
                },
                {
                    label: 'SW Registrado',
                    status: 'warning',
                    value: '‚è≥ Verificando...'
                },
                {
                    label: 'Manifest',
                    status: 'warning',
                    value: '‚è≥ Verificando...'
                }
            ];
            
            // Verificar service worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    pwa[1].status = registration ? 'ok' : 'warning';
                    pwa[1].value = registration ? '‚úÖ Activo' : '‚ö†Ô∏è No registrado';
                } catch (error) {
                    pwa[1].status = 'error';
                    pwa[1].value = '‚ùå Error';
                }
            }
            
            // Verificar manifest
            try {
                const response = await fetch('./manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    pwa[2].status = 'ok';
                    pwa[2].value = '‚úÖ Encontrado';
                } else {
                    pwa[2].status = 'warning';
                    pwa[2].value = '‚ö†Ô∏è No accesible';
                }
            } catch (error) {
                pwa[2].status = 'error';
                pwa[2].value = '‚ùå Error de carga';
            }
            
            updateStatus('pwa-status', pwa);
            addLog('‚úÖ Verificaci√≥n de PWA completada');
        }
        
        async function testLocalStorage() {
            addLog('üß™ Probando localStorage...');
            try {
                const testData = { test: 'data', timestamp: new Date().toISOString() };
                localStorage.setItem('gestor_test', JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem('gestor_test'));
                
                if (retrieved.test === 'data') {
                    addLog('‚úÖ localStorage funciona correctamente');
                    localStorage.removeItem('gestor_test');
                } else {
                    addLog('‚ùå Error en localStorage');
                }
            } catch (error) {
                addLog('‚ùå Error en localStorage: ' + error.message);
            }
        }
        
        async function testSupabase() {
            addLog('üß™ Probando conexi√≥n a Supabase...');
            try {
                if (typeof window.supabase === 'undefined') {
                    addLog('‚ùå Supabase no est√° cargado');
                    return;
                }
                
                // Importar configuraci√≥n de Supabase
                const { createClient } = window.supabase;
                
                // Usar la misma configuraci√≥n que la aplicaci√≥n principal
                const SUPABASE_URL = 'https://hqxghxslzewupwxooxvc.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxeGdoeHNsemV3dXB3eG9veHZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NDEyNzcsImV4cCI6MjA2ODMxNzI3N30.2hbwsGMSY3pPyJ18qQe8hOx-fFmM7EJ7pJGDs6Cc0jM';
                
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    addLog('‚ö†Ô∏è Credenciales de Supabase no configuradas');
                    return;
                }
                
                // Crear cliente
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Primero probar la conectividad b√°sica con auth
                addLog('üîç Verificando conectividad b√°sica...');
                try {
                    const { data: { session }, error: authError } = await supabaseClient.auth.getSession();
                    addLog('‚úÖ Cliente Supabase creado correctamente');
                } catch (authError) {
                    addLog('‚ö†Ô∏è Error de autenticaci√≥n: ' + authError.message);
                }
                
                // Luego probar conexi√≥n con una consulta simple a las tablas
                addLog('üîç Probando acceso a tablas...');
                const { data, error } = await supabaseClient
                    .from('ingresos')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        addLog('‚ö†Ô∏è Tabla "ingresos" no existe - Supabase conectado pero faltan tablas');
                        addLog('üí° Ejecuta las pol√≠ticas SQL para crear las tablas');
                    } else if (error.message.includes('cors') || error.message.includes('fetch')) {
                        addLog('üåê Posible problema de CORS - verifica la configuraci√≥n del dominio en Supabase');
                        addLog('üí° Agrega "localhost:8080" en Authentication > URL Configuration');
                    } else {
                        addLog('‚ùå Error de conexi√≥n: ' + error.message);
                        addLog('üîß C√≥digo de error: ' + (error.code || 'N/A'));
                    }
                } else {
                    addLog('‚úÖ Conexi√≥n a Supabase exitosa');
                    addLog('üìä Tablas accesibles desde la aplicaci√≥n');
                }
                
            } catch (error) {
                addLog('‚ùå Error en Supabase: ' + error.message);
            }
        }
        
        async function testPWA() {
            addLog('üß™ Probando funcionalidades PWA...');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js');
                    addLog('‚úÖ Service Worker registrado: ' + registration.scope);
                } catch (error) {
                    addLog('‚ùå Error al registrar Service Worker: ' + error.message);
                }
            } else {
                addLog('‚ùå Service Worker no soportado');
            }
        }
        
        async function runAllTests() {
            addLog('üöÄ Iniciando suite completa de pruebas...');
            addLog('='.repeat(50));
            
            // Limpiar log anterior parcialmente para no saturar
            const logElement = document.getElementById('system-log');
            const lines = logElement.textContent.split('\n');
            if (lines.length > 20) {
                logElement.textContent = 'üìã Log del sistema (√∫ltimas 20 l√≠neas):\n' + 
                    lines.slice(-20).join('\n') + '\n';
            }
            
            // Ejecutar todas las pruebas en secuencia
            await testLocalStorage();
            addLog('‚îÄ'.repeat(30));
            
            await testSupabase();
            addLog('‚îÄ'.repeat(30));
            
            await testPWA();
            addLog('‚îÄ'.repeat(30));
            
            addLog('üéâ Suite de pruebas completada');
            addLog('='.repeat(50));
        }
        
        function clearAllData() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todos los datos?')) {
                localStorage.clear();
                addLog('üóëÔ∏è Todos los datos locales eliminados');
                setTimeout(() => {
                    checkStorage();
                }, 500);
            }
        }
        
        // Cargar librer√≠as necesarias
        function loadLibraries() {
            const scripts = [
                'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2',
                'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js',
                'https://cdn.jsdelivr.net/npm/chart.js'
            ];
            
            let loaded = 0;
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    loaded++;
                    if (loaded === scripts.length) {
                        runAllChecks();
                    }
                };
                script.onerror = () => {
                    addLog('‚ùå Error cargando: ' + src);
                    loaded++;
                    if (loaded === scripts.length) {
                        runAllChecks();
                    }
                };
                document.head.appendChild(script);
            });
        }
        
        async function runAllChecks() {
            await checkComponents();
            await checkStorage();
            await checkPWA();
            addLog('üéâ Verificaci√≥n completa terminada');
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            addLog('üöÄ Iniciando diagn√≥stico del sistema...');
            loadLibraries();
        });
    </script>
</body>
</html>
