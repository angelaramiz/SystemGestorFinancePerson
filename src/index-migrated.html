<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💼 Sistema Gestor Financiero - Versión Migrada 🔄</title>
    
    <!-- 🎨 Estilos principales -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/ventanas.css">
    <link rel="stylesheet" href="../css/alertas.css">
    
    <!-- 📱 PWA Manifest -->
    <link rel="manifest" href="../../manifest.json">
    
    <!-- 🎯 Favicon -->
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
    
    <style>
        /* 🔧 Estilos específicos para versión migrada */
        .migration-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .system-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .status-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background-color: #4CAF50; }
        .status-warning { background-color: #FF9800; }
        .status-error { background-color: #F44336; }
        .status-info { background-color: #2196F3; }
        
        .metrics-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .dev-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 2px solid #667eea;
            z-index: 1000;
        }
        
        .dev-controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
        
        .dev-controls button:hover {
            background: #5a67d8;
        }
    </style>
</head>
<body>
    <!-- 🚀 Banner de Versión Migrada -->
    <div class="migration-banner">
        🔄 VERSIÓN MIGRADA - Sistema con Arquitectura Refactorizada
        <br><small>Usando DependencyInjector, EventBus, ValidationSystem, MetricsSystem y CacheSystem</small>
    </div>

    <!-- 🎮 Controles de Desarrollo -->
    <div class="dev-controls">
        <h4 style="margin: 0 0 10px 0; color: #333;">🛠️ Dev Tools</h4>
        <button onclick="initMigratedApp()">🚀 Inicializar App</button>
        <button onclick="showMetrics()">📊 Ver Métricas</button>
        <button onclick="showState()">🔍 Ver Estado</button>
        <button onclick="testSystems()">🧪 Test Sistemas</button>
        <button onclick="clearCache()">🗑️ Limpiar Caché</button>
        <button onclick="toggleDebug()">🐛 Toggle Debug</button>
    </div>

    <!-- 📊 Estado de Sistemas -->
    <div class="container">
        <h1>💼 Sistema de Gestión Financiera Personal</h1>
        <h2>🔄 Versión Migrada con Nuevos Sistemas Core</h2>
        
        <div id="systemStatus" class="system-status">
            <!-- Se llena dinámicamente -->
        </div>
        
        <div id="metricsDisplay" class="metrics-display" style="display: none;">
            <!-- Métricas en tiempo real -->
        </div>
        
        <!-- 📱 Interfaz principal de la aplicación -->
        <div id="appContainer">
            <div style="text-align: center; padding: 50px; color: #666;">
                <h3>🚀 Presiona "Inicializar App" para comenzar</h3>
                <p>La aplicación migrada utiliza los nuevos sistemas core para mejor rendimiento y mantenibilidad.</p>
            </div>
        </div>
    </div>

    <!-- 🔧 Scripts del sistema core -->
    <script type="module" src="js/core/DependencyInjector.js"></script>
    <script type="module" src="js/core/EventBus.js"></script>
    <script type="module" src="js/core/ValidationSystem.js"></script>
    <script type="module" src="js/core/MetricsSystem.js"></script>
    <script type="module" src="js/core/CacheSystem.js"></script>
    <script type="module" src="js/modules/logger.js"></script>
    
    <!-- 🚀 Aplicación migrada -->
    <script type="module" src="js/app-migrated.js"></script>
    
    <!-- 📊 Scripts de desarrollo y debugging -->
    <script type="module">
        // 🔧 Importar la aplicación migrada
        import GestorFinancieroMigrado from './js/app-migrated.js';
        
        // 🌍 Hacer disponible globalmente
        window.GestorFinancieroMigrado = GestorFinancieroMigrado;
        window.migratedApp = null;
        window.debugMode = true;
        
        console.log('✅ GestorFinancieroMigrado cargado correctamente');
    </script>
    
    <script>
        /**
         * 🚀 Inicializar aplicación migrada
         */
        async function initMigratedApp() {
            try {
                updateSystemStatus('app', 'info', 'Inicializando...');
                
                if (!window.GestorFinancieroMigrado) {
                    throw new Error('GestorFinancieroMigrado no está disponible');
                }
                
                window.migratedApp = new window.GestorFinancieroMigrado();
                await window.migratedApp.init();
                
                updateSystemStatus('app', 'success', 'Inicializado correctamente');
                updateAllSystemStatus();
                
                // 🎯 Actualizar interfaz
                document.getElementById('appContainer').innerHTML = `
                    <div style="text-align: center; padding: 30px; background: #e8f5e8; border-radius: 10px;">
                        <h3>✅ Aplicación Migrada Inicializada</h3>
                        <p>Todos los sistemas core están funcionando correctamente.</p>
                        <div style="margin: 20px 0;">
                            <button onclick="showMetrics()" style="margin: 5px;">📊 Ver Métricas</button>
                            <button onclick="showState()" style="margin: 5px;">🔍 Ver Estado</button>
                        </div>
                    </div>
                `;
                
                console.log('🎉 Aplicación migrada inicializada correctamente');
                
            } catch (error) {
                updateSystemStatus('app', 'error', `Error: ${error.message}`);
                console.error('❌ Error inicializando aplicación migrada:', error);
            }
        }
        
        /**
         * 📊 Mostrar métricas del sistema
         */
        function showMetrics() {
            if (!window.migratedApp) {
                alert('🚨 Primero debes inicializar la aplicación');
                return;
            }
            
            const metrics = window.migratedApp.getMetrics();
            const display = document.getElementById('metricsDisplay');
            
            display.innerHTML = `
                <h3>📊 Métricas del Sistema</h3>
                <pre>${JSON.stringify(metrics, null, 2)}</pre>
            `;
            display.style.display = 'block';
        }
        
        /**
         * 🔍 Mostrar estado de la aplicación
         */
        function showState() {
            if (!window.migratedApp) {
                alert('🚨 Primero debes inicializar la aplicación');
                return;
            }
            
            const state = window.migratedApp.getState();
            const display = document.getElementById('metricsDisplay');
            
            display.innerHTML = `
                <h3>🔍 Estado de la Aplicación</h3>
                <pre>${JSON.stringify(state, null, 2)}</pre>
            `;
            display.style.display = 'block';
        }
        
        /**
         * 🧪 Probar sistemas individualmente
         */
        async function testSystems() {
            if (!window.migratedApp) {
                alert('🚨 Primero debes inicializar la aplicación');
                return;
            }
            
            const di = window.migratedApp.di;
            
            try {
                // 🧪 Test EventBus
                const eventBus = di.resolve('eventBus');
                eventBus.emit('test:event', { message: 'Test desde dev tools' });
                updateSystemStatus('eventBus', 'success', 'Test exitoso');
                
                // 🧪 Test Cache
                const cache = di.resolve('cache');
                await cache.set('test:key', 'test:value');
                const value = await cache.get('test:key');
                updateSystemStatus('cache', value === 'test:value' ? 'success' : 'error', 
                    value === 'test:value' ? 'Test exitoso' : 'Test fallido');
                
                // 🧪 Test Validation
                const validation = di.resolve('validation');
                const testData = { monto: 100, categoria: 'test' };
                const validated = await validation.validateAndSanitize(testData, 'ingreso');
                updateSystemStatus('validation', 'success', 'Test exitoso');
                
                alert('🎉 Todos los tests de sistemas completados. Revisa el estado.');
                
            } catch (error) {
                console.error('❌ Error en tests de sistemas:', error);
                alert('🚨 Error en tests: ' + error.message);
            }
        }
        
        /**
         * 🗑️ Limpiar caché del sistema
         */
        async function clearCache() {
            if (!window.migratedApp) {
                alert('🚨 Primero debes inicializar la aplicación');
                return;
            }
            
            try {
                const cache = window.migratedApp.di.resolve('cache');
                await cache.clear();
                updateSystemStatus('cache', 'info', 'Caché limpiado');
                alert('🗑️ Caché limpiado correctamente');
            } catch (error) {
                console.error('❌ Error limpiando caché:', error);
                alert('🚨 Error limpiando caché: ' + error.message);
            }
        }
        
        /**
         * 🐛 Alternar modo debug
         */
        function toggleDebug() {
            window.debugMode = !window.debugMode;
            console.log(`🐛 Debug mode: ${window.debugMode ? 'ON' : 'OFF'}`);
            
            if (window.migratedApp) {
                const logger = window.migratedApp.di.resolve('logger');
                logger.setLevel(window.debugMode ? 'debug' : 'info');
            }
            
            updateSystemStatus('debug', window.debugMode ? 'success' : 'warning', 
                window.debugMode ? 'Debug ON' : 'Debug OFF');
        }
        
        /**
         * 📊 Actualizar estado de un sistema
         */
        function updateSystemStatus(system, status, message) {
            const container = document.getElementById('systemStatus');
            let card = document.getElementById(`status-${system}`);
            
            if (!card) {
                card = document.createElement('div');
                card.className = 'status-card';
                card.id = `status-${system}`;
                container.appendChild(card);
            }
            
            const systemNames = {
                'app': '🚀 Aplicación',
                'eventBus': '📡 EventBus',
                'cache': '🗄️ Cache',
                'validation': '✅ Validation',
                'metrics': '📊 Metrics',
                'debug': '🐛 Debug Mode'
            };
            
            card.innerHTML = `
                <h3>${systemNames[system] || system}</h3>
                <div>
                    <span class="status-indicator status-${status}"></span>
                    ${message}
                </div>
                <small style="color: #666;">Actualizado: ${new Date().toLocaleTimeString()}</small>
            `;
        }
        
        /**
         * 🔄 Actualizar estado de todos los sistemas
         */
        function updateAllSystemStatus() {
            updateSystemStatus('eventBus', 'success', 'Sistema de eventos funcionando');
            updateSystemStatus('cache', 'success', 'Sistema de caché activo');
            updateSystemStatus('validation', 'success', 'Sistema de validación listo');
            updateSystemStatus('metrics', 'success', 'Sistema de métricas recopilando');
            updateSystemStatus('debug', window.debugMode ? 'success' : 'warning', 
                window.debugMode ? 'Debug ON' : 'Debug OFF');
        }
        
        // 🚀 Inicialización automática del estado
        document.addEventListener('DOMContentLoaded', () => {
            updateSystemStatus('app', 'warning', 'No inicializada');
            updateAllSystemStatus();
            
            console.log(`
🔄 SISTEMA MIGRADO CARGADO
========================

🛠️ Comandos disponibles en consola:
- initMigratedApp()    : Inicializar aplicación
- showMetrics()        : Ver métricas
- showState()          : Ver estado
- testSystems()        : Probar sistemas
- clearCache()         : Limpiar caché
- toggleDebug()        : Toggle debug mode

📱 Usa los botones del panel de desarrollo en la esquina superior derecha.
            `);
        });
    </script>
</body>
</html>
